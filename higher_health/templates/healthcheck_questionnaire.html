{% extends 'base.html' %}
{% load temp_tags %}
{% block content %}
  {% comment %}
    {% if submitted %}
    <!-- IF THIS THEN STILL BEING USED? -->
      {% include "healthcheck_receipt.html" %}
    {% else %}
    {% endif %}
  {% endcomment %}
  <div class="content">
    <div class="content-intro">
      <div class="content-inner">
        <div class="heading-container">
          <h1 class="heading heading-primary">Welcome to HealthCheck <br/>Daily Health Screening Portal</h1>
          <h2 class="heading heading-secondary">Your daily risk assessment tool</h2>
          <h3>Please help us by answering a few questions about you and your health.</h3>
          <p>You will receive advice on what actions to take based on national
           guidelines and the data you enter will help us in predictive modelling
           and planning our national response to COVID-19.
           Thank you for coming forward and for contributing to the health
           of all citizens AND stopping the spread of the virus ðŸ¦ 
          </p>
        </div>
        <form action="" method="POST" id="login_form" class="login-form" novalidate>
        {% csrf_token %}
          <div class="login-form__read-terms">
            <ul id="read-terms" class="fieldset">
              <li>
                <input type="checkbox" id="healthcheck_terms" name="healthcheck-terms" required>
                <label for="healthcheck_terms" class="label">I accept the terms</label>
                <a href="/terms" class="label-link" target="_blank">Read terms and policy</a>
              </li>
            </ul>
          </div>
          <div id="questionnaires">
            <div class="login-form__location">
              <h2 class="heading-secondary">Personal Questionnaire</h2>
              <div class="login-form__screening">
                <ul class="fieldset">
                  {% for field in form %}
                    {% if "symptoms_" not in field.name and "medical_" not in field.name and field.name != "city" and field.name != "address" %}
                      <li>
                        {% if field|field_type != "HiddenInput" %}
                          {{field}}
                          <label for="{{ field.id_for_label }}" class="label">
                            <a href="">=={{field.label}}</a>
                          </label>
                          {{field.errors}}
                        {% endif %}
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
              <p class="subtitle">Sharing your location data will help us to further accurately map cases of COVID-19</p>
              <div class="login-form__map">
                <div id="locationField">
                  <input id="autocomplete"
                    placeholder="Type your physical address"
                    onFocus="geolocate()"
                    type="text"
                    value="{{ form.address.value|default_if_none:"" }}"
                    name="address"/>
                </div>
                {% if form.latitude or form.longitude %}
                  {{form.latitude}}
                  {{form.longitude}}
                  {% if form.latitude.errors or form.longitude.errors %}
                      {{form.latitude.errors}}
                  {% endif %}
                {% endif %}
                <div class="location-field-autoload">
                  <p class="location-field-hint">The below physical address fields will be automatically populated from the address entered above. Otherwise please fill in the information.</p>
                  <ul id="address" class="address-list fieldset">
                    <li class="address-list__item">
                      <input class="field" id="street_number" disabled="true"/>
                      <input class="field" id="route" disabled="true"/>
                      <label for="street_number" class="label">Street address:</label>
                    </li>
                    <li class="address-list__item">
                      <input class="field" name="city" id="locality" disabled="true"/>
                      <label for="locality" class="label">City:</label>
                    </li>
                    <li class="address-list__item">
                      <input class="field" id="country" disabled="true"/>
                      <label for="country" class="label">Country:</label>
                    </li>
                  </ul>
                </div>
              </div>


            </div>

            <div class="login-form__medical">
              <h2 class="heading-secondary">Medical Questionnaire</h2>
              <ul id="medical" class="fieldset">
                {% for field in form %}
                  {% if "symptoms_" in field.name or "medical_" in field.name %}
                    {% if field.name == "medical_confirm_accuracy" %}
                      <h3 class="subheading">And finally</h3>
                    {% endif %}
                    <li>
                      <label for="sweating" class="label">{{ field.label }}</label>
                      {{field.errors}}
                      {{ field }}
                    </li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
            <button id="entrySubmit" type="submit" class="cta cta-primary">Check</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block form_js %}
  <script type="text/javascript">
  "use strict";
    const checkbox = document.getElementById('healthcheck_terms'),
      questionnairesForm = document.getElementById('questionnaires'),
      addressField = document.getElementById('autocomplete');

    document.addEventListener('DOMContentLoaded',function(e) {
      //Review & cleanup
      let checkboxKey = sessionStorage.getItem('checkbox');
      if(checkboxKey === 'true') {
        checkbox.checked = true;
        questionnairesForm.classList.add('showing');
        questionnairesForm.classList.remove('hidden');
      } else {
        checkbox.checked = false;
        questionnairesForm.classList.add('hidden');
        questionnairesForm.classList.remove('showing');
      }
      checkbox.addEventListener('change', function(e){
        if (e.target.checked) {
          sessionStorage.setItem('checkbox', 'true');
          questionnairesForm.classList.add('showing');
          questionnairesForm.classList.remove('hidden');
        } else {
          sessionStorage.setItem('checkbox', 'false');
          questionnairesForm.classList.add('hidden');
          questionnairesForm.classList.remove('showing');
        }
      });
    });

    /*----GOOGLE PLACES REVIEW----*/
    let placeSearch, autocomplete;
    const componentForm = {
      street_number: 'short_name',
      route: 'long_name',
      locality: 'long_name',
      country: 'long_name'
    };

    function initAutocomplete() {
      // Create the autocomplete object, restricting the search predictions to
      // geographical location types.
      autocomplete = new google.maps.places.Autocomplete(
          document.getElementById('autocomplete'), {types: ['geocode']});

      // Avoid paying for data that you don't need by restricting the set of
      // place fields that are returned to just the address components.
      autocomplete.setFields(['address_components', 'geometry']);

      // When the user selects an address from the drop-down, populate the
      // address fields in the form.
      autocomplete.addListener('place_changed', fillInAddress);
    }

    function fillInAddress() {
      // Get the place details from the autocomplete object.
      let cityInput = autocomplete.getPlace();

      for (let component in componentForm) {
        document.getElementById(component).value = '';
        document.getElementById(component).disabled = false;
      }

      let location = cityInput.geometry.location;
      document.getElementById('id_latitude').value = location.lat();
      document.getElementById('id_longitude').value = location.lng();

      // Get each component of the address from the place details,
      // and then fill-in the corresponding field on the form.
      for (let i = 0; i < cityInput.address_components.length; i++) {
        let addressType = cityInput.address_components[i].types[0];
        if (componentForm[addressType]) {
          let val = cityInput.address_components[i][componentForm[addressType]];
          document.getElementById(addressType).value = val;
        }
      }
    }

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          let geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          let circle = new google.maps.Circle(
            {center: geolocation, radius: position.coords.accuracy});
          autocomplete.setBounds(circle.getBounds());
        });
      }
    }
  </script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={{PLACES_API_KEY}}&libraries=places&callback=initAutocomplete"
      async defer></script>
{% endblock %}
