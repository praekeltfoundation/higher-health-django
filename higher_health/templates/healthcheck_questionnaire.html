{% extends 'base.html' %}
{% load temp_tags static compress cache %}
{% block content %}
  <div class="content">
    <div class="content-intro">
      <div class="content-inner content-inner--questionnaires">

        <div class="heading-container">
          <h1 class="heading heading-primary">Welcome to HealthCheck</h1>
          <h2 class="heading heading-secondary">Your daily risk assessment tool.</h2>
          <h3 class="heading heading-subtitle">Please help us by answering a few questions about you and your health.</h3>
          <p>
            You will receive advice on what actions to take based on national guidelines,
            and the data you enter will help us in predictive modelling and planning
            our national response to COVID-19.

            Thank you for coming forward and for contributing to the
            health of all citizens AND stopping the spread of the virus ðŸ¦ 
          </p>
        </div>

        <form action="" method="POST" id="login_form" class="login-form" novalidate>
        {% csrf_token %}
          <div class="login-form__read-terms">
            <ul id="read-terms" class="fieldset">
              <li class="fieldset__item">
                <input type="checkbox" id="healthcheck_terms" name="healthcheck-terms" required>
                <label for="healthcheck_terms" class="label">I accept the terms</label>
                <a href="/terms" class="label-link" target="_blank">Read terms and policy</a>
              </li>
            </ul>
          </div>
          <div id="questionnaires">
            <div class="collapsibles__item login-form__location">
              <div class="pagination">
                <p class="pagination__label">Step 1 of 4</p>
                <span class="pagination__icon">+</span>
              </div>
              <div class="collapsibles__label">
                <h3 class="heading heading-secondary">Registration</h3>
              </div>
              <div id="step_1" class="collapsibles__toggle">
                <div class="login-form__screening">
                  {% if form.errors %}
                    <p class="error">Please correct the errors below</p>
                  {% endif %}
                  <ul id="registration" class="fieldset">
                    {% for field in form.registration_fields %}
                      <li class="fieldset__item">
                        <label for="{{ field.id_for_label }}" class="label">
                          {{field.label}}
                        </label>
                        {{field}}
                        {{field.errors}}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
                <p class="subtitle">Sharing your location data will help us to further accurately map cases of COVID-19</p>
                <div class="login-form__map">
                  <div id="locationField">
                    <input id="autocomplete"
                      placeholder="Type your physical address"
                      onFocus="geolocate()"
                      type="text"
                      value="{{ form.address.value|default_if_none:'' }}"
                      name="address"/>
                      {% if form.address.errors  %}{{form.address.errors}}{% endif %}
                  </div>
                  {% if form.latitude or form.longitude %}
                    {{form.latitude}}
                    {{form.longitude}}
                  {% endif %}
                  <div class="location-field-autoload">
                    <p class="location-field-hint">The below physical address fields will be automatically populated from the address entered above. Otherwise please fill in the information.</p>
                    <ul id="address" class="address-list fieldset">
                      <li class="address-list__item">
                        <input class="field" name="street_number" id="street_number" readonly value="{{ form.street_number.value|default_if_none:'' }}"/>
                        <input class="field" name="route" id="route" readonly value="{{ form.route.value|default_if_none:'' }}"/>
                        <label for="street_number" class="label">Street address:</label>
                      </li>
                      <li class="address-list__item">
                        <input class="field" name="city" id="locality" readonly value="{{ form.city.value|default_if_none:'' }}"/>
                        <label for="locality" class="label">City:</label>
                      </li>
                      <li class="address-list__item">
                        <input class="field" name="country" id="country" readonly value="{{ form.country.value|default_if_none:'' }}"/>
                        <label for="country" class="label">Country:</label>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <div class="collapsibles__item login-form__medical">
              <div class="pagination">
                <p class="pagination__label">Step 2 of 4</p>
                <span class="pagination__icon">+</span>
              </div>
              <div class="collapsibles__label">
                <h2 class="heading-secondary">Where are you going today?</h2>
              </div>
              <div id="step_2" class="collapsibles__toggle">
                <ul id="destination" class="fieldset">
                  {% for field in form.destination_fields %}
                    {% if field.name == "facility_destination_university" %}
                      <h3 class="heading-subtitle heading-subtitle--edu-label">Educational institution information</h3>
                    {% endif %}
                    <li class="fieldset__item">
                      <label for="{{ field.name }}" class="label">{{ field.label }}</label>
                      {% if field|field_type == 'RadioSelect' %}
                        <ul id='id_{{ field.name }}'>
                        {% for value, text in field.field.choices %}
                          <li>
                            <input name="{{ field.name }}"
                             id="id_{{ field.name|slugify }}_{{ forloop.counter0 }}" type="radio" value="{{ value }}" {% if field.value == value %}checked="checked"{% endif %}/>
                            <label for="id_{{ field.name|slugify }}_{{ forloop.counter0 }}">{{ text|capfirst }}</label>
                          </li>
                        {% endfor %}
                        </ul>
                        {{field.errors}}
                      {% else %}
                        {{field}}
                        {{field.errors}}
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <div class="collapsibles__item login-form__medical">
              <div class="pagination">
                <p class="pagination__label">Step 3 of 4</p>
                <span class="pagination__icon">+</span>
              </div>
              <div class="collapsibles__label">
                <h2 class="heading-secondary">Medical History</h2>
              </div>
              <div id="step_3" class="collapsibles__toggle">
                <ul id="medical-history" class="fieldset">
                  <li class="fieldset__medical">
                    <label for="{{ form.history_pre_existing_condition.name }}" class="label">
                      {{ form.history_pre_existing_condition.label }}
                    </label>
                    <ul id='id_{{form.history_pre_existing_condition.name}}'>
                      {% for value, text in form.history_pre_existing_condition.field.choices %}
                        <li>
                          <input name="{{ form.history_pre_existing_condition.name }}"
                           id="id_{{ form.history_pre_existing_condition.name|slugify }}_{{ forloop.counter0 }}" type="radio" value="{{ value }}" {% if field.value == value %}checked="checked"{% endif %}/>
                          <label for="id_{{ form.history_pre_existing_condition.name|slugify }}_{{ forloop.counter0 }}">{{ text|capfirst }}</label>
                        </li>
                      {% endfor %}
                    </ul>
                  </li>
                </ul>
                <ul id="preexistingconditionsForm" class="fieldset">
                  {% for field in form.history_fields %}
                    <li class="fieldset__medical">
                      {% if field|field_type == 'RadioSelect' %}
                        <ul id='id_{{ field.name }}'>
                        {% for value, text in field.field.choices %}
                          <li>
                            <input name="{{ field.name }}"
                             id="id_{{ field.name|slugify }}_{{ forloop.counter0 }}" type="radio" value="{{ value }}" {% if field.value == value %}checked="checked"{% endif %}/>
                            <label for="id_{{ field.name|slugify }}_{{ forloop.counter0 }}">{{ text|capfirst }}</label>
                          </li>
                        {% endfor %}
                        </ul>
                        {{field.errors}}
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <div class="collapsibles__item login-form__medical">
              <p class="pagination-ux">Step 4 of 4</p>
              <h2 class="heading-secondary">How are you feeling today?</h2>
              <ul id="medical" class="fieldset">
                {% for field in form.medical_fields %}
                  {% if field.name == "medical_confirm_accuracy" %}
                    <h3 class="heading-subtitle heading-subtitle--edu-label">Confirmation</h3>
                  {% endif %}
                  <li class="fieldset__item">
                    <label for="{{ field.name }}" class="label">{{ field.label }}</label>
                    {% if field|field_type == 'RadioSelect' %}
                      <ul id='id_{{ field.name }}'>
                      {% for value, text in field.field.choices %}
                        <li>
                          <input name="{{ field.name }}"
                           id="id_{{ field.name|slugify }}_{{ forloop.counter0 }}" type="radio" value="{{ value }}" {% if field.value == value %}checked="checked"{% endif %}/>
                          <label for="id_{{ field.name|slugify }}_{{ forloop.counter0 }}">{{ text|capfirst }}</label>
                        </li>
                      {% endfor %}
                      </ul>
                      {{field.errors}}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
              {% if form.errors %}
                <p class="error">Please correct all the errors before submitting.</p>
              {% endif %}
            </div>
            <button id="entrySubmit" type="submit" class="cta cta-primary">Submit</button>
          </div>

        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block form_js %}

{% cache 300 json_data %}

{% endcache %}

{{ universities|json_script:"universities-data" }}

{{ campuses|json_script:"campus-data" }}

<!--inline-->
{% compress js  %}
  <script type="text/javascript">
  "use strict";

  console.log(JSON.parse(document.getElementById('universities-data').textContent));

  // let paginate = document.querySelectorAll('.pagination__icon'),
  //   sessionToggle = sessionStorage.getItem('steps') ? JSON.parse(sessionStorage.getItem('steps')) : {},
  //   collapsed;
  //
  // for(let i = 0; i < paginate.length; i++) {
  //   paginate[i].innerHTML = '-';
  //   let collapsiblesToggle = paginate[i].parentElement.nextElementSibling.nextElementSibling.getAttribute('id')
  //
  //   paginate[i].addEventListener('click', function(e) {
  //     let nextElem = this.parentElement.nextElementSibling.nextElementSibling;
  //     if(document.getElementById(nextElem.getAttribute('id')).style.display === ''){
  //       document.getElementById(nextElem.getAttribute('id')).style.display = 'none';
  //       paginate[i].innerHTML = '+';
  //       collapsed = true;
  //     } else if(document.getElementById(nextElem.getAttribute('id')).style.display === 'none') {
  //       document.getElementById(nextElem.getAttribute('id')).style.display = 'block';
  //       paginate[i].innerHTML = '-';
  //       collapsed = false;
  //     } else if(document.getElementById(nextElem.getAttribute('id')).style.display === 'block') {
  //       document.getElementById(nextElem.getAttribute('id')).style.display = 'none';
  //       paginate[i].innerHTML = '+';
  //       collapsed = true;
  //     }
  //
  //     sessionToggle[nextElem.getAttribute('id')] = collapsed;
  //     sessionStorage.setItem('steps', JSON.stringify(sessionToggle));
  //   });
  //
  //   if(sessionToggle[collapsiblesToggle] !== undefined) {
  //     if(sessionToggle[collapsiblesToggle] === true) {
  //       document.getElementById(collapsiblesToggle).style.display = 'none';
  //       paginate[i].innerHTML = '+';
  //     } else {
  //       document.getElementById(collapsiblesToggle).style.display = 'block';
  //       paginate[i].innerHTML = '-';
  //     }
  //     //Not doing a proper reset
  //     if(document.body.contains(document.querySelectorAll('.errorlist')[i]) === true) {
  //       document.getElementById(collapsiblesToggle).style.display = 'block';
  //       paginate[i].innerHTML = '-';
  //       sessionStorage.setItem('steps',JSON.stringify({}));
  //     }
  //
  //   }
  // };

  /*
  let universities = JSON.parse(document.getElementById('universities-data').textContent),
  campuses = JSON.parse(document.getElementById('campus-data').textContent);
    let prov = document.getElementById('id_facility_destination_province'),
      uni = document.getElementById('id_facility_destination_university'),
      camp = document.getElementById('id_facility_destination_campus'),
      uniClone = uni.cloneNode(true),
      campClone = camp.cloneNode(true),
      formSubmit = document.getElementById('login_form'),
      addressInput = document.getElementById('autocomplete'),
      latInput = document.getElementById('id_latitude'),
      lngInput = document.getElementById('id_longitude'),
      isPageLoad=true;

    let selected_province = prov.options[prov.selectedIndex];
    showHiddenInputs(selected_province.value, uniClone, uni, universities);
    showHiddenInputs(uni.options[uni.selectedIndex].value, campClone, camp, campuses);
    clearCampus();
    prov.addEventListener('change', function() {
      showHiddenInputs(this.value, uniClone, uni, universities);
      showHiddenInputs(uni.value, campClone, camp, campuses);
      clearCampus();
    });
    uni.addEventListener('change', function() {
      showHiddenInputs(this.value, campClone, camp, campuses);
    });

    function showHiddenInputs(elem, clonedElems, selectInputs, csvInputElem) {
      selectInputs.options.length = 0;

      for(let i = 0; i < clonedElems.options.length; i++) {
        let uniChild = clonedElems.options[i];
        if(csvInputElem[uniChild.value] == elem || csvInputElem[uniChild.value] == undefined) {
          selectInputs.appendChild(uniChild.cloneNode(true));
        }
      }
    };
    function clearCampus() {
      if(!isPageLoad){
        uni.value = '';
        camp.value = '';
      }
    }


    //GOOGLE PLACES API: AUTOCOMPLETE
    let placeSearch, autocomplete;
    const componentForm = {
      street_number: 'short_name',
      route: 'long_name',
      locality: 'long_name',
      country: 'long_name'
    };

    function initAutocomplete() {
      // Create the autocomplete object, restricting the search predictions to
      // geographical location types.
      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('autocomplete'), {
          strictbounds: true,
          types: ['geocode'],
          componentRestrictions: { country: "ZA" }
        });

      // Avoid paying for data that you don't need by restricting the set of
      // place fields that are returned to just the address components.
      autocomplete.setFields(['address_components', 'geometry']);

      // When the user selects an address from the drop-down, populate the
      // address fields in the form.
      addressInput.addEventListener('keyup',function(e){
        e.target.value = this.value;
        latInput.value = '';
        lngInput.value = '';
      });
      autocomplete.addListener('place_changed', function(){
        let thisPlace = this.getPlace();
        let cityInput = autocomplete.getPlace();

        for (let component in componentForm) {
          document.getElementById(component).value = '';
        }

        let location = cityInput.geometry.location;
        latInput.value = location.lat();
        lngInput.value = location.lng();

        // Get each component of the address from the place details,
        // and then fill-in the corresponding field on the form.
        for (let i = 0; i < cityInput.address_components.length; i++) {
          let addressType = cityInput.address_components[i].types[0];
          if (componentForm[addressType]) {

            let val = cityInput.address_components[i][componentForm[addressType]];
            console.log(componentForm[addressType], val);

            document.getElementById(addressType).value = val;
          }
        }
      });
    }

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          let geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          let circle = new google.maps.Circle(
            {center: geolocation, radius: position.coords.accuracy});
          autocomplete.setBounds(circle.getBounds());
        });
      }
    }

    //MEDICAL
    const checkbox = document.getElementById('healthcheck_terms'),
    questionnairesForm = document.getElementById('questionnaires'),
    addressField = document.getElementById('autocomplete'),
    preexistingconditionsYes= document.getElementById('id_history_pre_existing_condition_0'),
    preexistingconditionsNo= document.getElementById('id_history_pre_existing_condition_1'),
    preexistingconditionsNotsure= document.getElementById('id_history_pre_existing_condition_2');
    document.addEventListener('DOMContentLoaded',function(e) {
      //Review & cleanup
      let checkboxKey = sessionStorage.getItem('checkbox');
      if(checkboxKey === 'true') {
        checkbox.checked = true;
        questionnairesForm.classList.add('showing');
        questionnairesForm.classList.remove('hidden');
      } else {
        checkbox.checked = false;
        questionnairesForm.classList.add('hidden');
        questionnairesForm.classList.remove('showing');
      }
      checkbox.addEventListener('change', function(e){
        if (e.target.checked) {
          sessionStorage.setItem('checkbox', 'true');
          questionnairesForm.classList.add('showing');
          questionnairesForm.classList.remove('hidden');
        } else {
          sessionStorage.setItem('checkbox', 'false');
          questionnairesForm.classList.add('hidden');
          questionnairesForm.classList.remove('showing');
        }
      });

      //Pre-existing conditions Yes & cleanup
      let preexistingRadioKey = sessionStorage.getItem('preexistingRadio');
      if(preexistingRadioKey === 'yes' || preexistingRadioKey === 'not_sure') {
        if(preexistingRadioKey === 'yes') {
          preexistingconditionsYes.checked = true;
        }
        else {
          preexistingconditionsNotsure.checked = true;
        }

        preexistingconditionsForm.classList.add('showing');
        preexistingconditionsForm.classList.remove('hidden');
      } else {
        preexistingconditionsYes.checked = false;
        preexistingconditionsForm.classList.add('hidden');
        preexistingconditionsForm.classList.remove('showing');
      }
      preexistingconditionsYes.addEventListener('change', function(e){
        if (e.target.checked) {
          sessionStorage.setItem('preexistingRadio', 'yes');
          preexistingconditionsForm.classList.add('showing');
          preexistingconditionsForm.classList.remove('hidden');
        } else {
          sessionStorage.setItem('preexistingRadio', 'no');
          preexistingconditionsForm.classList.add('hidden');
          preexistingconditionsForm.classList.remove('showing');
        }
      });

      preexistingconditionsNo.addEventListener('change', function(e){
        if (e.target.checked) {
          sessionStorage.setItem('preexistingRadio', 'no');
          preexistingconditionsForm.classList.add('hidden');
          preexistingconditionsForm.classList.remove('showing');
        }
      });
      preexistingconditionsNotsure.addEventListener('change', function(e){
        if (e.target.checked) {
          sessionStorage.setItem('preexistingRadio', 'not_sure');
          preexistingconditionsForm.classList.add('showing');
          preexistingconditionsForm.classList.remove('hidden');
        } else {
          sessionStorage.setItem('preexistingRadio', 'no');
          preexistingconditionsForm.classList.add('hidden');
          preexistingconditionsForm.classList.remove('showing');
        }
      });
      let ErrorList = document.querySelectorAll('.errorlist');
      if(ErrorList.length > 0) {
        ErrorList[0].parentElement.scrollIntoView({
          bahavior: "smooth",
          block: "start"
        });
      }
    });
    isPageLoad = false;
    */
  </script>
{% endcompress %}

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key={{PLACES_API_KEY}}&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}
